<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Discord Multi-Chat Viewer with Stats & Graphs</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { margin:0; font-family:system-ui, -apple-system, BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,sans-serif; background:#313338; color:#dbdee1; display:flex; height:100vh; }
#sidebar { width:300px; background:#1e1f22; border-right:1px solid #111214; display:flex; flex-direction:column; }
#folderInput { margin:12px; }
#chatSearch { margin:8px 12px; padding:4px; border-radius:4px; border:none; width:calc(100% - 24px); }
#sortSelect { margin:0 12px 12px 12px; padding:4px; }
#fileList { flex:1; overflow-y:auto; padding:8px 12px; }
.fileItem { padding:6px 8px; border-radius:6px; cursor:pointer; font-size:14px; }
.fileItem:hover { background:#2b2d31; }
#mainContainer { flex:1; display:flex; flex-direction:column; overflow:hidden; }
#messageSearch { margin:8px 16px; padding:4px; border-radius:4px; border:none; width:calc(100% - 32px); }
#main { flex:1; overflow-y:auto; padding:16px; border-top:1px solid #111214; }
.message { display:flex; gap:12px; margin-bottom:14px; }
.avatar { width:40px; height:40px; border-radius:50%; background:#5865f2; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; flex-shrink:0; }
.header { display:flex; gap:8px; align-items:baseline; }
.username { font-weight:600; color:#f2f3f5; }
.timestamp { font-size:12px; color:#949ba4; }
.text { white-space:pre-wrap; line-height:1.4; }
#statsPanel { width:400px; background:#1e1f22; overflow-y:auto; padding:16px; }
.statsSection { margin-bottom:16px; }
.statsSection h3 { margin:0 0 8px 0; font-size:16px; border-bottom:1px solid #5865f2; padding-bottom:4px; }
.statsItem { margin-bottom:4px; }
.sectionHeader { font-weight:bold; margin-top:8px; margin-bottom:4px; color:#00a8fc; }
#graphOptions { margin:8px 0 12px 0; }
canvas { background:#2b2d31; border-radius:6px; width:100%; }
img.embedded { max-width:100%; height:auto; border-radius:6px; display:block; margin-top:4px; }
iframe.embed { 
  width:100%; 
  max-width:100%; 
  height:400px; 
  border:none; 
  border-radius:6px; 
  margin-top:4px; 
}
</style>
</head>
<body>
<div id="sidebar">
  <input type="file" id="folderInput" webkitdirectory multiple>
  <input type="text" id="chatSearch" placeholder="Search chats...">
  <select id="sortSelect">
    <option value="recent">Most Recent</option>
    <option value="oldest">Oldest</option>
    <option value="messages">Most Messages</option>
    <option value="alpha">Alphabetical</option>
    <option value="duration">Longest Duration</option>
  </select>
  <div id="fileList"></div>
</div>

<div id="mainContainer">
  <input type="text" id="messageSearch" placeholder="Search messages...">
  <div id="main">Drop folder here or select using input.</div>
</div>
<div id="statsPanel"></div>

<script>
let indexMap = {};
let conversations = [];
let perChatChart=null, overallChart=null;
let currentChat=null;
const hourShift = 17;

const folderInput = document.getElementById('folderInput');
const fileList = document.getElementById('fileList');
const main = document.getElementById('main');
const statsPanel = document.getElementById('statsPanel');
const sortSelect = document.getElementById('sortSelect');
const chatSearch = document.getElementById('chatSearch');
const messageSearch = document.getElementById('messageSearch');

folderInput.addEventListener('change', e => { processFolder([...e.target.files]); });
sortSelect.addEventListener('change', renderSidebar);
chatSearch.addEventListener('input', renderSidebar);
messageSearch.addEventListener('input', ()=>{ if(currentChat) renderMessages(currentChat.messages); });

function processFolder(files){
  const groupedChats = {};
  files.forEach(file => {
    const pathParts=file.webkitRelativePath.split('/');
    if(pathParts.length<2) return;
    const folderName=pathParts[1];

    if(file.name==='index.json'){
      const reader=new FileReader();
      reader.onload=()=>{ 
        try{ 
          indexMap=JSON.parse(reader.result); 
          refreshLabels(); 
        } catch(err){console.error('Failed to parse index.json:',err);} 
      };
      reader.readAsText(file);
      return;
    }

    if(folderName.startsWith('c')){
      if(!groupedChats[folderName]) groupedChats[folderName]={};
      if(file.name==='channel.json') groupedChats[folderName].channel=file;
      if(file.name==='messages.json') groupedChats[folderName].messages=file;
    }
  });

  Object.entries(groupedChats).forEach(([folderName, filesObj])=>{
    if(!filesObj.messages){ console.warn(`No messages.json in ${folderName}`); return; }
    const chat={messages:null, channel:null};

    const readChannel=filesObj.channel?new Promise(resolve=>{
      const reader=new FileReader();
      reader.onload=()=>{ chat.channel=JSON.parse(reader.result); resolve(); };
      reader.readAsText(filesObj.channel);
    }):Promise.resolve();

    const readMessages=new Promise(resolve=>{
      const reader=new FileReader();
      reader.onload=()=>{
        const msgs=JSON.parse(reader.result);
        msgs.forEach(m=>{
          if(m.Timestamp){
            const d=new Date(m.Timestamp);
            d.setUTCHours((d.getUTCHours()+hourShift)%24);
            m._shiftedTime=d;
          } else m._shiftedTime=null;
        });
        chat.messages=msgs;
        resolve();
      };
      reader.readAsText(filesObj.messages);
    });

    Promise.all([readChannel, readMessages]).then(()=>{
      conversations.push(chat);
      renderSidebar();
    }).catch(err=>console.error(`Error loading chat ${folderName}:`,err));
  });
}

function getConversationLabel(conv){
  if(!conv.channel||!conv.channel.id) return 'Unknown Conversation';
  return indexMap[conv.channel.id] || conv.channel.id;
}

function isDM(conv){ return conv.channel && conv.channel.type==='DM'; }

function renderSidebar(){
  fileList.innerHTML='';
  const sortBy=sortSelect.value;
  const query = chatSearch.value.toLowerCase();

  function sortChats(arr){
    return arr.slice().sort((a,b)=>{
      if(!a.messages||!b.messages) return 0;
      const firstA=a.messages[0]?a.messages[0]._shiftedTime||new Date(a.messages[0].Timestamp) : new Date(0);
      const firstB=b.messages[0]?b.messages[0]._shiftedTime||new Date(b.messages[0].Timestamp) : new Date(0);
      const lastA=a.messages[a.messages.length-1]?a.messages[a.messages.length-1]._shiftedTime||new Date(a.messages[a.messages.length-1].Timestamp) : new Date(0);
      const lastB=b.messages[b.messages.length-1]?b.messages[b.messages.length-1]._shiftedTime||new Date(b.messages[b.messages.length-1].Timestamp) : new Date(0);
      const durationA=Math.abs(lastA-firstA);
      const durationB=Math.abs(lastB-firstB);

      switch(sortBy){
        case 'recent': return lastB-lastA;
        case 'oldest': return firstA-firstB;
        case 'messages': return (b.messages.length||0)-(a.messages.length||0);
        case 'alpha': return getConversationLabel(a).localeCompare(getConversationLabel(b));
        case 'duration': return durationB-durationA;
      }
    });
  }

  function filterChats(arr){ return sortChats(arr).filter(c => getConversationLabel(c).toLowerCase().includes(query)); }

  const dms = filterChats(conversations.filter(isDM));
  const servers = filterChats(conversations.filter(c=>!isDM(c)));

  if(dms.length>0){
    const dh=document.createElement('div'); dh.className='sectionHeader'; dh.textContent='Direct Messages'; fileList.appendChild(dh);
    dms.forEach(conv=>{
      const item=document.createElement('div'); item.className='fileItem';
      item.textContent=getConversationLabel(conv);
      item.onclick=()=>{currentChat=conv; renderMessages(conv.messages); showStats(conv);};
      conv._el=item;
      fileList.appendChild(item);
    });
  }

  if(servers.length>0){
    const sh=document.createElement('div'); sh.className='sectionHeader'; sh.textContent='Server / Channels'; fileList.appendChild(sh);
    servers.forEach(conv=>{
      const item=document.createElement('div'); item.className='fileItem';
      item.textContent=getConversationLabel(conv);
      item.onclick=()=>{currentChat=conv; renderMessages(conv.messages); showStats(conv);};
      conv._el=item;
      fileList.appendChild(item);
    });
  }
}

function refreshLabels(){
  conversations.forEach(conv=>{
    if(conv._el) conv._el.textContent=getConversationLabel(conv);
  });
}

function renderMessages(messages){
  main.innerHTML='';
  const searchQuery = messageSearch.value.toLowerCase();
  messages.slice().sort((a,b)=>b._shiftedTime - a._shiftedTime).forEach(msg=>{
    if(searchQuery && !((msg.Contents||'').toLowerCase().includes(searchQuery))) return;

    const row=document.createElement('div'); row.className='message';
    const av=document.createElement('div'); av.className='avatar'; av.textContent='U';
    const body=document.createElement('div');
    const head=document.createElement('div'); head.className='header';
    const user=document.createElement('span'); user.className='username'; user.textContent=msg.Author||'User';
    const time=document.createElement('span'); time.className='timestamp';
    time.textContent=msg._shiftedTime ? msg._shiftedTime.toLocaleString() : '';
    head.appendChild(user); head.appendChild(time);
    body.appendChild(head);

    // Attachments as scaled images
    if(msg.Attachments){
      const img=document.createElement('img');
      img.src=msg.Attachments;
      img.className='embedded';
      body.appendChild(img);
    }

    if(msg.Contents){
      const urls = msg.Contents.match(/https?:\/\/\S+/g) || [];
      urls.forEach(url => {
        if(url.match(/\.(gif|png|jpg|jpeg)$/i)){ 
          const img=document.createElement('img'); 
          img.src=url; 
          img.className='embedded'; 
          body.appendChild(img);
        } else if(url.includes('tenor.com') || url.includes('giphy.com')) {
          const iframe=document.createElement('iframe');
          iframe.src=url;
          iframe.className='embed';
          iframe.allow='accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
          iframe.allowFullscreen=true;
          body.appendChild(iframe);
        } else { 
          const link=document.createElement('a'); 
          link.href=url; 
          link.textContent=url; 
          link.target='_blank'; 
          link.style.color='#00a8fc'; 
          body.appendChild(link);
        }
      });

      const text=document.createElement('div'); text.className='text'; text.textContent=msg.Contents;
      body.appendChild(text);
    }

    row.appendChild(av); row.appendChild(body);
    main.appendChild(row);
  });
}

function showStats(conv){
  statsPanel.innerHTML='';
  if(!conv.messages||conv.messages.length===0){ statsPanel.textContent='No messages in this chat.'; return; }
  const totalMessages=conv.messages.length;
  const allMessages = conversations.flatMap(c=>c.messages||[]);

  const first=conv.messages[0]._shiftedTime;
  const last=conv.messages[conv.messages.length-1]._shiftedTime;
  const durationDays=Math.floor(Math.abs(last-first)/(1000*60*60*24));
  const attachmentsCount=conv.messages.filter(m=>m.Attachments).length;

  const userCount={};
  conv.messages.forEach(m=>{ const u=m.Author||'Unknown'; userCount[u]=(userCount[u]||0)+1; });
  const chatPct=((totalMessages/allMessages.length)*100).toFixed(1);
  const avgPerDay = durationDays>0 ? (totalMessages/durationDays).toFixed(1) : totalMessages;

  const section=document.createElement('div'); section.className='statsSection';
  section.innerHTML=`<h3>${getConversationLabel(conv)}</h3>
    <div class="statsItem">Total Messages: ${totalMessages} (${chatPct}% of all messages)</div>
    <div class="statsItem">Attachments: ${attachmentsCount}</div>
    <div class="statsItem">First: ${first.toLocaleString()}</div>
    <div class="statsItem">Last: ${last.toLocaleString()}</div>
    <div class="statsItem">Duration: ~${durationDays} days</div>
    <div class="statsItem">Avg messages/day: ${avgPerDay}</div>
    <div class="statsItem"><strong>Messages by User:</strong></div>`;
  Object.entries(userCount).sort((a,b)=>b[1]-a[1]).forEach(([user,count])=>{
    const pct=((count/totalMessages)*100).toFixed(1);
    const totalPct=((count/allMessages.length)*100).toFixed(1);
    const div=document.createElement('div'); div.className='statsItem';
    div.textContent=`${user}: ${count} (${pct}% of chat, ${totalPct}% of all messages)`;
    section.appendChild(div);
  });

  const perCanvas=document.createElement('canvas'); perCanvas.id='perChatGraph'; perCanvas.height=200; section.appendChild(perCanvas);
  const intervalDiv=document.createElement('div'); intervalDiv.id='graphOptions';
  intervalDiv.innerHTML='Graph Interval: <select id="intervalSelectLocal"><option value="hour">Hourly</option><option value="day">Daily</option><option value="month">Monthly</option><option value="year">Yearly</option></select>';
  section.appendChild(intervalDiv);
  statsPanel.appendChild(section);

  const overallSection=document.createElement('div'); overallSection.className='statsSection';
  const overallFirst=new Date(Math.min(...allMessages.map(m=>m._shiftedTime?.getTime()||new Date(m.Timestamp).getTime())));
  const overallLast=new Date(Math.max(...allMessages.map(m=>m._shiftedTime?.getTime()||new Date(m.Timestamp).getTime())));
  const overallDurationDays=Math.floor(Math.abs(overallLast-overallFirst)/(1000*60*60*24));
  const overallAttachments=allMessages.filter(m=>m.Attachments).length;
  overallSection.innerHTML=`<h3>Overall Stats (All Chats)</h3>
    <div class="statsItem">Total Messages: ${allMessages.length}</div>
    <div class="statsItem">Attachments: ${overallAttachments}</div>
    <div class="statsItem">First: ${overallFirst.toLocaleString()}</div>
    <div class="statsItem">Last: ${overallLast.toLocaleString()}</div>
    <div class="statsItem">Duration: ~${overallDurationDays} days</div>`;
  const overallCanvas=document.createElement('canvas'); overallCanvas.id='overallGraph'; overallCanvas.height=200; overallSection.appendChild(overallCanvas);
  statsPanel.appendChild(overallSection);

  const intervalSelectLocal = document.getElementById('intervalSelectLocal');
  intervalSelectLocal.addEventListener('change',()=>{ updateGraphs(conv, allMessages, intervalSelectLocal.value); });
  updateGraphs(conv, allMessages, intervalSelectLocal.value);
}

function updateGraphs(conv, allMessages, interval){
  function getLabelsAndCounts(messages){
    const counts={};
    messages.forEach(m=>{
      const d=m._shiftedTime||new Date(m.Timestamp);
      let key;
      if(interval==='hour') key=d.getHours();
      else if(interval==='day') key=d.getDay();
      else if(interval==='month') key=d.getMonth();
      else if(interval==='year') key=d.getFullYear();
      counts[key]=(counts[key]||0)+1;
    });

    let labels=[], data=[];
    if(interval==='hour'){
      labels=Array.from({length:24},(_,i)=>{ const h=i%12||12; return `${h} ${i<12?'AM':'PM'}`; });
      data=labels.map((_,i)=>counts[i]||0);
    } else if(interval==='day'){
      const dayLabels=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
      labels=dayLabels;
      data=dayLabels.map((_,i)=>counts[i]||0);
    } else if(interval==='month'){
      const monthLabels=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      labels=monthLabels;
      data=monthLabels.map((_,i)=>counts[i]||0);
    } else if(interval==='year'){
      const years=Array.from(new Set(messages.map(m=>m._shiftedTime?.getFullYear()||new Date(m.Timestamp).getFullYear()))).sort();
      labels=years;
      data=years.map(y=>counts[y]||0);
    }
    return {labels,data};
  }

  const perCtx=document.getElementById('perChatGraph').getContext('2d');
  const perData=getLabelsAndCounts(conv.messages);
  if(perChatChart) perChatChart.destroy();
  perChatChart=new Chart(perCtx,{type:'bar',data:{labels:perData.labels,datasets:[{label:'Messages',data:perData.data,backgroundColor:'#5865f2'}]},options:{responsive:true,plugins:{legend:{display:false}}}});

  const overallCtx=document.getElementById('overallGraph').getContext('2d');
  const overallData=getLabelsAndCounts(allMessages);
  if(overallChart) overallChart.destroy();
  overallChart=new Chart(overallCtx,{type:'bar',data:{labels:overallData.labels,datasets:[{label:'Messages',data:overallData.data,backgroundColor:'#00a8fc'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}
</script>
</body>
</html>
